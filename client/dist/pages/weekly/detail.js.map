{"version":3,"sources":["/src/pages/weekly/detail.js"],"names":["apiUrl","require","storageKey","Page","data","id","isEdited","datas","content","title","text","placeholder","onLoad","e","that","wx","getStorage","key","weeklyDetail","success","res","tmp","setData","removeStorage","fail","_getWeeklyCurrent","onShow","onUnload","tmpDatas","console","log","showModal","confirm","navigateTo","url","setStorage","complete","textConfirm","textBlur","target","dataset","index","detail","value","cancelText","confirmText","_postWeekly","weeklyCurrent","parseInt","summary_this_week","plan_next_week","problem","cb","_post","showToast","request","postWeeklyDetail","method","header","statusCode","icon","duration","navigateBack"],"mappings":"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","file":"detail.js","sourcesContent":["const apiUrl = require('../../utils/api')\nconst storageKey = require('../../utils/util').storageKey\n\nPage({\n  data: {\n    id: 0,\n    isEdited: false,\n    datas: {\n      id: 0,\n      content: [{\n        title: '本周工作总结',\n        text: '',\n        placeholder: '总结一下这周做了哪些工作'\n      }, {\n        title: '下周工作计划',\n        text: '',\n        placeholder: '计划一下下周的工作任务'\n      }, {\n        title: '感想',\n        text: '',\n        placeholder: '谈谈这周工作的感想与心得'\n      }]\n    }\n  },\n  onLoad (e) {\n    var that = this\n\n    wx.getStorage({\n      key: storageKey.weeklyDetail,\n      success: function (res) {\n        if (res.data) {\n          var tmp = res.data\n          that.setData({\n            datas: tmp,\n            isEdited: true\n          })\n          wx.removeStorage({ key: storageKey.weeklyDetail })\n        }\n      },\n      fail: function (res) {\n        that._getWeeklyCurrent(e.id, that)\n      }\n    })\n  },\n  onShow () {\n\n  },\n  onUnload () {\n    var that = this\n    var tmpDatas = this.data.datas\n\n    console.log('Weekly detail on unload.')\n\n    if (this.data.isEdited) {\n      wx.showModal({\n        title: '友情提醒',\n        content: '之前的周报尚未保存，是否返回继续编辑',\n        success: function (res) {\n          if (res.confirm) {\n            console.log('confirm.' + that.data.datas)\n\n            wx.navigateTo({\n              url: '/pages/weekly/detail?id=' + that.data.id\n            })\n\n            wx.setStorage({\n              key: storageKey.weeklyDetail,\n              data: tmpDatas\n            })\n          }\n        },\n        complete: function () {\n\n        }\n      })\n    }\n  },\n  textConfirm: function (e) {\n    console.log('confirm.')\n  },\n  textBlur: function (e) {\n    var tmp = this.data.datas\n\n    tmp.content[e.target.dataset.index].text = e.detail.value\n\n    this.setData({\n      datas: tmp,\n      isEdited: true\n    })\n  },\n  confirm: function () {\n    let that = this\n\n    wx.showModal({\n      title: '提交',\n      content: '将周报提交到资源库',\n      cancelText: '取消',\n      confirmText: '提交',\n      // cancelColor: 'red',\n      // confirmColor: '#3CC51F', 默认即为#3CC51F\n      success: function (res) {\n        if (res.confirm) {\n          console.log('提交.')\n          that._postWeekly(that)\n          // 提交一个表单\n        } else {\n          // console.log('存稿.')\n          // 同样提交一个表单，只不过存储位置不同\n        }\n      },\n      fail: function (res) {\n\n      }\n    })\n  },\n  _getWeeklyCurrent: function (id, that) {\n    wx.getStorage({\n      key: storageKey.weeklyCurrent,\n      success: function (res) {\n        if (parseInt(id) === parseInt(res.data.id)) {\n          let datas = that.data.datas\n          let content = datas.content\n          content[0].text = res.data.summary_this_week\n          content[1].text = res.data.plan_next_week\n          content[2].text = res.data.problem\n          datas.content = content\n\n          that.setData({\n            datas: datas,\n            weeklyCurrent: res.data\n          })\n        }\n      }\n    })\n  },\n  _postWeekly: function (that, cb) {\n    let weeklyCurrent = that.data.weeklyCurrent\n\n    if (weeklyCurrent) {\n      weeklyCurrent.summary_this_week = that.data.datas.content[0].text\n      weeklyCurrent.plan_next_week = that.data.datas.content[1].text\n      weeklyCurrent.problem = that.data.datas.content[2].text\n\n      that._post(that, weeklyCurrent, cb)\n    } else {\n      wx.getStorage({\n        key: storageKey.weeklyCurrent,\n        success: function (res) {\n          weeklyCurrent = res.data\n\n          weeklyCurrent.summary_this_week = that.data.datas.content[0].text\n          weeklyCurrent.plan_next_week = that.data.datas.content[1].text\n          weeklyCurrent.problem = that.data.datas.content[2].text\n\n          that._post(that, weeklyCurrent, cb)\n        }\n      })\n    }\n  },\n  _post: function (that, data, cb) {\n    console.log('POST data: ', data)\n    wx.showToast({title: '提交中...'})\n    wx.request({\n      url: apiUrl.postWeeklyDetail,\n      data: data,\n      method: 'POST',\n      header: {\n        'content-type': 'application/json'\n      },\n      success: function (res) {\n        console.log('success res: ', res)\n        if (res.statusCode === 200) {\n          wx.showToast({\n            title: '上传成功',\n            icon: 'success',\n            duration: 2000,\n            complete: function () {\n              console.log('123')\n              that.data.isEdited = false\n              wx.navigateBack()\n            }\n          })\n        } else {\n          wx.showToast({\n            title: '上传失败',\n            icon: 'fail',\n            duration: 2000,\n            complete: function () {\n              console.log('123')\n            }\n          })\n        }\n      },\n      fail: function (res) {\n        wx.showToast({\n          title: '上传失败',\n          icon: 'fail',\n          duration: 2000,\n          complete: function () {\n            console.log('123')\n          }\n        })\n        console.log('fail res: ', res)\n      },\n      complete: function (res) {\n        typeof cb === 'function' && cb()\n      }\n    })\n  }\n})\n"]}